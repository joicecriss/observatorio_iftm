<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <title>Observatório IFTM</title>
  <link rel="icon" type="image/x-icon" href="src/assets/obs.svg" />
  <script>
    // Define base href dinamicamente
    const isLocal =
      window.location.hostname === "localhost" ||
      window.location.hostname === "127.0.0.1";
    const baseHref = isLocal
      ? "/"
      : "/bibliotecas/wbc/govbr-ds-wbc-quickstart-js/";
    document.write('<base href="' + baseHref + '" />');
  </script>
  <link rel="stylesheet" href="https://cdngovbr-ds.estaleiro.serpro.gov.br/design-system/fonts/rawline/css/rawline.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway:300,400,500,600,700,800,900&amp;display=swap" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
  <link rel="stylesheet" href="node_modules/@govbr-ds/core/dist/core.min.css" />
  <link rel="stylesheet" href="src/style.css" />
</head>

<body>
  <header class="br-header mb-4" id="header" data-sticky="data-sticky">
    <div class="container-fluid">
      <div class="header-top">
        <div class="header-logo">
          <img src="src/assets/logo_obs.png" alt="logo" /><span class="br-divider vertical"></span>
          <div class="header-sign">
            Observatório IFTM
          </div>
        </div>
      </div>
      <div class="header-bottom">
        <div class="header-menu">
          <div class="header-menu-trigger" id="header-navigation">
            <button class="br-button small circle" type="button" aria-label="Menu" data-toggle="menu" data-target="#main-navigation" id="navigation">
              <i class="fas fa-bars" aria-hidden="true"></i>
            </button>
          </div>
          <div class="header-info">
            <div class="header-title">Consulta de Docentes</div>
          </div>
        </div>
      </div>
    </div>
  </header>
  <main class="d-flex flex-fill mb-5" id="main">
    <div class="container-fluid d-flex">
      <div class="row">
        <div class="br-menu push active" id="main-navigation" style="width: 250px">
          <div class="menu-container">
            <div class="menu-panel">
              <nav class="menu-body" role="tree">
                <a class="menu-item divider" href="" role="treeitem">
                  <span class="icon"><i class="fas fa-home" aria-hidden="true"></i></span>
                  <span class="content">Home</span>
                </a>
                <a class="menu-item divider" href="formulario.html" role="treeitem">
                  <span class="icon"><i class="fas fa-check-circle" aria-hidden="true"></i></span>
                  <span class="content">Formulário</span>
                </a>
                <a class="menu-item divider" href="consulta-docentes.html" role="treeitem">
                  <span class="icon"><i class="fas fa-check-circle" aria-hidden="true"></i></span>
                  <span class="content">Consulta de Docentes</span>
                </a>
              </nav>
            </div>
          </div>
        </div>
        <div class="col mb-5">
          <nav class="br-breadcrumb">
            <ol class="crumb-list" role="list">
              <li class="crumb home">
                <a class="br-button circle" href=""><span class="sr-only">Página inicial</span><i class="fas fa-home"></i></a>
              </li>
              <li class="crumb" data-active="active">
                <i class="icon fas fa-chevron-right"></i><span tabindex="0" aria-current="page">Página atual</span>
              </li>
            </ol>
          </nav>
          <div class="main-content pl-sm-3 mt-4" id="main-content">
            <section>
              <div class="br-select" id="selectCampi">
                <div class="br-input">
                  <label for="campi">Escolha o campus:</label>
                  <input id="campi" type="text" placeholder="Selecione..." readonly>
                  <button class="br-button" type="button" aria-label="Exibir lista" data-trigger>
                    <i class="fas fa-angle-down"></i>
                  </button>
                </div>
                <div class="br-list" tabindex="0" role="listbox"></div>
              </div>
              <div class="mt-3">
                <h4><span id="campusSelecionado">Todos os Campi</span></h4>
                <p><strong>Número de docentes:</strong> <span id="totalDocentes">0</span></p>
                <p><strong>Número de docentes com Lattes:</strong> <span id="totalLattes">0</span></p>
              </div>
              <div class="row mt-4">
                <div class="col-md-6">
                  <h6>Última Atualização do Lattes</h6>
                  <canvas id="graficoLattes"></canvas>
                </div>
                <div class="col-md-6">
                  <h6>Titularidade</h6>
                  <canvas id="graficoTitulos"></canvas>
                </div>
              </div>
              <h5 class="mt-5">Filtragem de todos os docentes</h5>
              <div class="br-input">
                <label for="pesquisa">Pesquisar docente</label>
                <input id="pesquisa" type="text" placeholder="Digite um nome...">
              </div>
              <div class="table-responsive mt-3">
                <table class="br-table" id="tabelaDocentes">
                  <thead>
                    <tr>
                      <th></th>
                      <th>Nome</th>
                      <th>Email</th>
                      <th>Graduação</th>
                      <th>Data Lattes</th>
                      <th>Lattes</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
              <div class="br-pagination" id="paginacao" aria-label="Paginação" data-current="1" data-total="1">
                <ul>
                  <li>
                    <button class="br-button circle" type="button" data-previous-page aria-label="Voltar página">
                      <i class="fas fa-angle-left" aria-hidden="true"></i>
                    </button>
                  </li>
                  <li><a class="page active" aria-label="Página 1" href="javascript:void(0)">1</a></li>
                  <li>
                    <button class="br-button circle" type="button" data-next-page aria-label="Página seguinte">
                      <i class="fas fa-angle-right" aria-hidden="true"></i>
                    </button>
                  </li>
                </ul>
              </div>
            </section>
          </div>
        </div>
      </div>
    </div>
  </main>
  <footer class="br-footer">
    <div class="container-fluid row justify-content-between">
      <div class="logo col d-flex align-items-end">
        <img src="src/assets/logo_obs.png" alt="Imagem" />
        <h4 class="header-sign m-0">bservatório IFTM</h4>
      </div>
      <div class="assigns col d-flex justify-content-end">
        <a href="https://www.gov.br/acessoainformacao/pt-br" target="_blank"><img class="ml-4" src="/src/assets/logo_acesso_informacao.svg" alt="Imagem" /></a>
        <a href="https://www.gov.br/acessoainformacao/pt-br" target="_blank"><img class="ml-4" src="/src/assets/logo_gov.png" alt="Imagem" /></a>
      </div>
    </div>
    <span class="br-divider my-3"></span>
    <div class="container-fluid">
      <div class="info">
        <div class="text-down-01 text-medium pb-3">
          Desenvolvido por aluno - IFTM - Versão 1.0
        </div>
      </div>
    </div>
  </footer>

  <script type="module"
    src="https://cdn.jsdelivr.net/npm/@govbr-ds/webcomponents/dist/webcomponents/webcomponents.esm.js"></script>
  <!-- Não use esse o `core-init.js` em produção. Consulte a documentação do DS para entender melhor como instanciar os componentes -->
  <script type="module" src="node_modules/@govbr-ds/core/dist/core-init.min.js"></script>

  <script>
    // Função para definir o menu ativo baseado na URL
    function setActiveMenuItem() {
      const menuItems = document.querySelectorAll(".menu-item");
      const currentPath = window.location.pathname;

      menuItems.forEach((item) => {
        // Remove a classe active de todos os itens
        item.classList.remove("active");

        const href = item.getAttribute("href");

        // Normaliza os caminhos para comparação
        const normalizedCurrent = currentPath.replace(/\/$/, "") || "/";
        const normalizedHref = href.replace(/\/$/, "") || "/";

        // Verifica se o href corresponde à URL atual
        if (
          normalizedCurrent === normalizedHref ||
          (normalizedCurrent === "/" && normalizedHref === "") ||
          (normalizedCurrent === "" && normalizedHref === "") ||
          (normalizedCurrent.includes("formulario") &&
            normalizedHref.includes("formulario")) ||
          (normalizedCurrent === "/formulario.html" &&
            normalizedHref === "formulario.html")
        ) {
          item.classList.add("active");
        }
      });
    }

    // Executa quando o DOM é carregado
    document.addEventListener("DOMContentLoaded", setActiveMenuItem);
  </script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    let docentes = [];
    let filtrados = [];

    const selectCampi = document.getElementById('campi');
    const campusSelecionado = document.getElementById('campusSelecionado');
    const totalDocentes = document.getElementById('totalDocentes');
    const totalLattes = document.getElementById('totalLattes');
    const pesquisa = document.getElementById('pesquisa');
    const tbody = document.querySelector('#tabelaDocentes tbody');

    const nomesCampi = {
      "CV": "Campina Verde"
      , "ITU": "Ituiutaba"
      , "PAR": "Paracatu"
      , "PM": "Patos de Minas"
      , "PAT": "Patrocínio"
      , "URA": "Uberaba"
      , "UPT": "Uberaba Parque Tecnológico"
      , "UDI": "Uberlândia"
      , "UC": "Uberlândia Centro"
    };

    let graficoLattes, graficoTitulos;

    // 1. Carrega JSON
    fetch('ListaPesquisadores.json')
      .then(r => r.json())
      .then(json => {
        docentes = json;
        preencherSelectCampi();
        aplicarFiltros();
      });

    // 2. Preenche o select de campi
    function preencherSelectCampi() {
      const lista = document.querySelector('#selectCampi .br-list');
      lista.innerHTML = ''; // limpa antes

      // Adiciona "Todos"
      lista.innerHTML += `
        <div class="br-item" role="option">
          <div class="br-radio">
            <input id="campus-todos" type="radio" name="campus" value="" checked>
            <label for="campus-todos">Todos os Campi</label>
          </div>
        </div>
      `;

      // Adiciona campi únicos
      const campiUnicos = [...new Set(docentes.map(d => d.instituicao))];
      campiUnicos.forEach(c => {
        const nome = nomesCampi[c] || c;
        lista.innerHTML += `
          <div class="br-item" role="option">
            <div class="br-radio">
              <input id="campus-${c}" type="radio" name="campus" value="${c}">
              <label for="campus-${c}">${nome}</label>
            </div>
          </div>
        `;
      });

      // Evento de mudança
      lista.querySelectorAll('input[type="radio"]').forEach(r => {
        r.addEventListener('change', () => {
          selectCampi.dataset.value = r.value;

          // Mostra o nome completo no campo visível
          document.getElementById('campi').value = r.value
            ? (nomesCampi[r.value] || r.value)
            : "Todos os Campi";
          
          aplicarFiltros();

          // Fecha o select corretamente simulando clique no botão
          const trigger = document.querySelector('#selectCampi [data-trigger]');
          if (trigger) trigger.click();
        });
      });
    }

    // 3. Aplica filtros
    function aplicarFiltros() {
      let dados = [...docentes];

      // filtro por campus
      const campus = selectCampi.dataset.value || "";
      if (campus) dados = dados.filter(d => d.instituicao === campus);

      // filtro por pesquisa
      const q = pesquisa.value.toLowerCase();
      if (q) dados = dados.filter(d => d.nome.toLowerCase().includes(q));

      filtrados = dados;
      atualizarResumo();
      atualizarTabela();
      atualizarGraficos();
    }

    // 4. Atualiza KPIs
    function atualizarResumo() {
      const campusSelecionadoCodigo = selectCampi.dataset.value || "";
      campusSelecionado.textContent = campusSelecionadoCodigo
        ? (nomesCampi[campusSelecionadoCodigo] || campusSelecionadoCodigo)
        : "Todos os Campi";

      totalDocentes.textContent = filtrados.length;
      totalLattes.textContent = filtrados.filter(d => d.lattesEndereco).length;
    }


    // 6. Atualiza gráficos
    function atualizarGraficos() {
      // Lattes por ano
      const anos = {};
      filtrados.forEach(d => {
        if (d.dataAtualizacaoLattes) {
          const ano = d.dataAtualizacaoLattes.split('/')[0];
          anos[ano] = (anos[ano] || 0) + 1;
        }
      });

      const ctx1 = document.getElementById('graficoLattes').getContext('2d');
      if (graficoLattes) graficoLattes.destroy();
      graficoLattes = new Chart(ctx1, {
        type: 'pie',
        data: {
          labels: Object.keys(anos),
          datasets: [{ data: Object.values(anos), backgroundColor: ['#1351B4', '#26A69A', '#F57C00', '#7B1FA2'] }]
        }
      });

      // Titulações (um docente pode contar em vários)
      const titulos = { graduacao: 0, mestrado: 0, doutorado: 0 };
      filtrados.forEach(d => {
        if (d.graduacao) titulos.graduacao++;
        if (d.mestrado) titulos.mestrado++;
        if (d.doutorado) titulos.doutorado++;
      });

      const ctx2 = document.getElementById('graficoTitulos').getContext('2d');
      if (graficoTitulos) graficoTitulos.destroy();
      graficoTitulos = new Chart(ctx2, {
        type: 'pie',
        data: {
          labels: ['Graduação', 'Mestrado', 'Doutorado'],
          datasets: [{ data: Object.values(titulos), backgroundColor: ['#FFD54F', '#42A5F5', '#8E24AA'] }]
        }
      });
    }

    // Eventos
    selectCampi.addEventListener('change', aplicarFiltros);
    pesquisa.addEventListener('input', aplicarFiltros);
  </script>

  <script>
    let paginaAtual = 1;
    const itensPorPagina = 20;

    function atualizarTabela() {
      const inicio = (paginaAtual - 1) * itensPorPagina;
      const fim = inicio + itensPorPagina;
      const paginaDados = filtrados.slice(inicio, fim);

      tbody.innerHTML = paginaDados.map(d => `
        <tr>
          <td><img src="${d.urlFoto}" width="50" 
            onerror="this.src='src/assets/user-default.gif'"></td>
          <td>${d.nome}</td>
          <td>${d.email || ''}</td>
          <td>${d.graduacao || '-'}</td>
          <td>${d.dataAtualizacaoLattes || '-'}</td>
          <td>${d.lattesEndereco ? `<a href="${d.lattesEndereco}" target="_blank"><i class="fas fa-link"></i></a>` : '-'}</td>
          <td><button class="br-button small circle" onclick="toggleExpand(${d.professorID})">+</button></td>
        </tr>
        <tr id="detalhes-${d.professorID}" class="detalhes" style="display:none;">
          <td colspan="7">
            <div class="br-card">
              <div class="card-content">
                <p><strong>Mestrado:</strong> ${d.mestrado || '-'}</p>
                <p><strong>Doutorado:</strong> ${d.doutorado || '-'}</p>
              </div>
            </div>
          </td>
        </tr>
      `).join('');

      renderizarPaginacao();
    }

    function renderizarPaginacao() {
      const totalPaginas = Math.ceil(filtrados.length / itensPorPagina);
      const paginacao = document.getElementById('paginacao');

      paginacao.setAttribute('data-total', totalPaginas);
      paginacao.setAttribute('data-current', paginaAtual);

      const botoes = Array.from({ length: totalPaginas }, (_, i) =>
        `<li><a class="page ${paginaAtual === i + 1 ? 'active' : ''}" 
           href="javascript:void(0)" 
           onclick="mudarPagina(${i + 1})">${i + 1}</a></li>`).join('');

      paginacao.querySelector('ul').innerHTML = `
        <li>
          <button class="br-button circle" type="button" data-previous-page 
                  ${paginaAtual === 1 ? 'disabled' : ''}
                  onclick="mudarPagina(${paginaAtual - 1})">
            <i class="fas fa-angle-left"></i>
          </button>
        </li>
        ${botoes}
        <li>
          <button class="br-button circle" type="button" data-next-page 
                  ${paginaAtual === totalPaginas ? 'disabled' : ''}
                  onclick="mudarPagina(${paginaAtual + 1})">
            <i class="fas fa-angle-right"></i>
          </button>
        </li>
      `;
    }

    function mudarPagina(num) {
      paginaAtual = num;
      atualizarTabela();
    }

    function toggleExpand(id) {
      const tr = document.getElementById('detalhes-'+id);
      tr.style.display = tr.style.display === 'none' ? '' : 'none';
    }

  </script>
</body>

</html>